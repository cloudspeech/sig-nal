const e={},t=[(e,t)=>e[t],(e,t)=>e.hasAttribute(t),(e,t)=>e.getAttribute(t),e=>1];class n extends WeakMap{use=(e,t={})=>this.get(e)||this.set(e,t).get(e)}const s=new n,i=new n,a=new n,o=(e,t)=>"number"===t?0|e:e;export class Signal{#e;#t=new EventTarget;#n=0;constructor(e){this.#e=e}#s=()=>1==++this.#n&&queueMicrotask((()=>{this.#t.dispatchEvent(new CustomEvent("change",{detail:this.#e})),this.#n=0}));get value(){return this.#e}set value(e){this.#e=e,this.#s()}onChange(e,t){t&&e(this.#e),this.#t.addEventListener("change",(({detail:t})=>e(t)))}when(e,t=[]){let n=new Signal(e(this.#e));return this.onChange((t=>n.value=e(t))),t.forEach((e=>e.when(this.#s))),n}}class c extends HTMLElement{#i=(e,t=this)=>t.getAttribute(e);#a=(e,n)=>{let s=e[0],a=e.slice(1),o=this.#i(e,n),c=".?!@".indexOf(s);if(c>=0){const s=t[c](n,a);i.use(n)[e]={init:s,name:o},queueMicrotask((()=>n.removeAttribute(e)))}};static#o={};static Signal=Signal;static hydrate=(t,n,o)=>{for(let h of t){const t=document.querySelector(h).shadowRoot,l=a.get(t)||e;for(let a in n){const h=s.get(t)[a],r=i.get(h);if(!r)continue;const u=n[a];for(let t in u){let n=u[t];t in c.#o&&(n=c.#o[t](n));const{name:s,init:i}=r[t.toLowerCase()]||e,{signal:a,type:g,id:d}=s&&l[s]||e;o instanceof Object&&d&&a&&(o[d]=a);const m=t.slice(1),f=e=>n({type:g,name:m,signal:a,signals:l,init:i,domNode:h,e:e});s&&(t.startsWith("@")?h.addEventListener(m,f):queueMicrotask(f))}}}};static plugin=(e,t)=>c.#o[e]=t;static rerender=({signal:e,name:t,domNode:n},s=!0)=>e.onChange((e=>n[t]=e),s);static render=e=>({domNode:t,name:n})=>t[n]="function"==typeof e?e():e;connectedCallback(){const e=this[this.#i("for")||"parentNode"],t=this.getRootNode(),n=this.#i("new"),i=n||this.#i("ref"),c=this.#i("type"),{id:h,textContent:l}=this;s.use(t)[i]=e,n&&(a.use(t)[i]={signal:new Signal(o(l,c)),type:c,id:h});for(let t of e.getAttributeNames())this.#a(t,e);this.className||this.replaceWith(l)}}customElements.define("sig-nal",c);
