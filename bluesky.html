<!doctype html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="sig-nal bluesky real-time messages demo" />
    <title>sig-nal | bluesky real-time messages demo</title>
    <script type="module" src="./src/index.js"></script>
  </head>
  <body>
    <template shadowrootmode="open">
      <style>
        * {
          font-family: sans-serif;
        }
        p {
          color: #fff;
          background: #555;
          padding: 0.5rem;
          width: fit-content;
        }
        ul {
          margin: 0;
          padding: 0;
        }
        li {
          width: 100%;
          overflow-x: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          content-visibility: auto;
        }
      </style>
      <h1>Bluesky real-time messages demo</h1>
      <p>showing the last 10 messages</p>
      <div>
        <ul>
          <li id="messages0">loading...</li>
          <li id="messages1">loading...</li>
          <li id="messages2">loading...</li>
          <li id="messages3">loading...</li>
          <li id="messages4">loading...</li>
          <li id="messages5">loading...</li>
          <li id="messages6">loading...</li>
          <li id="messages7">loading...</li>
          <li id="messages8">loading...</li>
          <li id="messages9">loading...</li>
        </ul>
        <!-- prettier-ignore -->
        <sig-nal new="messages" hydrate>
          {"": { "@init": ({signal}) => {
                 let last10 = [{}, {}, {}, {}, {}, {}, {}, {}, {}, {}];
                 signal.value = last10;
                 let ws = new WebSocket('wss://jetstream2.us-west.bsky.network/subscribe?wantedCollections=app.bsky.feed.post');
                 ws.onmessage = event => {
                     let {kind, commit} = JSON.parse(event.data);
                     if (kind !== 'commit' || commit.operation !== 'create') return;
                     let message = commit.record.text.replaceAll(/\n/g, ' ');
                     let filter = location.search.slice(1);
                     if (filter && !message.includes(filter)) return;
                     for(let i = 1; i < 10; i++) last10[i-1].textContent = last10[i].textContent;
                     last10[9].textContent = message;
                     signal.value = last10;
                   };
                 },
                 ".firstElementChild": renderWith(object,false)
              }
          }
        </sig-nal>
      </div>
    </template>
  </body>
</html>
